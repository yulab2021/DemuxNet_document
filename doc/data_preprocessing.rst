Data Preparation
================

DemuxNet requires a sparse single-cell expression matrix in **RDS** format
(genes as rows, cells as columns).

Recommendation
--------------

Before demultiplexing, filter the cell matrix to retain only high-confidence cells.
You can refer to the ``assignment_confidence_table.csv`` generated by 10x Cellranger multi:

``your/path/to/outs/multi/multiplexing_analysis/assignment_confidence_table.csv``

R Preprocessing Script
----------------------

.. code-block:: R

   library(Seurat)
   library(deMULTIplex2)
   library(dplyr)

   # ======= Load Files =======
   cmo <- Read10X('/your/path/to/outs/multi/count/raw_feature_bc_matrix/')
   cmo_df <- read.csv('your/path/to/outs/multi/multiplexing_analysis/assignment_confidence_table.csv')

   # ======= Data Preprocessing ========
   # Filter out Blank and Multiplet assignments
   filered_cmo_df <- cmo_df %>% filter(!(Assignment %in% c('Blank','Multiplet')))

   # Extract cell-gene matrix
   cmo_mtx <- cmo$`Gene Expression`[, colnames(cmo$`Gene Expression`) %in% filered_cmo_df$Barcode]
   print(dim(cmo_mtx))

   # Extract cell-CMO tag information
   cmo_tag_mtx <- t(cmo$`Multiplexing Capture`[, filered_cmo_df$Barcode])

   # ======= Tagging using Traditional Methods =======
   cmo_res <- demultiplexTags(cmo_tag_mtx, plot.path = './', plot.name = 'cmo', plot.diagnostics = FALSE)

   cmo_assign_table <- cmo_res$assign_table
   cmo_assign_table$Barcode <- rownames(cmo_assign_table)

   # Create a dataframe with labeled barcodes
   cmo_bc_df <- data.frame(Barcode = colnames(cmo_mtx)) %>%
       left_join(cmo_assign_table[, c("Barcode","final_assign")], by = "Barcode") %>%
       mutate(barcode = paste(final_assign, Barcode, sep = '_'))

   print(identical(colnames(cmo_mtx), cmo_bc_df$Barcode))

   # Replace with labeled Barcodes
   colnames(cmo_mtx) <- cmo_bc_df$barcode

   # ====== Save Data =========
   saveRDS(cmo_mtx, 'your/path/to/cmo_mtx.rds')

Example Matrix Format
---------------------

.. code-block:: text

                      CMO303_AAACCCAAGCACTCCG-1 CMO301_AAACCCAAGCGATGCA-1
   ENSONIG00000018423                     .                          .
   ENSONIG00000032772                     .                          .
   ENSONIG00000007536                     .                          .
   ENSONIG00000033498                     .                          .
